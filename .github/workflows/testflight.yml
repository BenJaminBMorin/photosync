name: Deploy to TestFlight

on:
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - '.github/workflows/testflight.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to TestFlight
    runs-on: [self-hosted, macos]

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Check Fastlane
      run: |
        if ! command -v fastlane &> /dev/null; then
          echo "Installing Fastlane..."
          brew install fastlane
        else
          echo "Fastlane already installed: $(fastlane --version)"
        fi

    - name: Set up App Store Connect API Key
      working-directory: ios
      env:
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
        KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
      run: |
        mkdir -p ~/.appstoreconnect/private_keys
        echo "$APP_STORE_CONNECT_API_KEY_KEY" > ~/.appstoreconnect/private_keys/AuthKey_${KEY_ID}.p8

    - name: Configure Git for Match
      env:
        MATCH_TOKEN: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        git config --global credential.helper store
        echo "https://${MATCH_TOKEN}@github.com" > ~/.git-credentials
        git config --global url."https://${MATCH_TOKEN}@github.com/".insteadOf "https://github.com/"

    - name: Set Build Number
      id: build_number
      run: |
        BUILD_NUMBER=$(git rev-list --count HEAD)
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
        echo "Using build number: $BUILD_NUMBER"

    - name: Update Project Build Number
      working-directory: ios
      run: |
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.build_number.outputs.build_number }}" PhotoSync/Info.plist

    - name: Setup Keychain
      run: |
        # For self-hosted runner, ensure login keychain is properly configured
        # Set as default keychain (required for match to work)
        security default-keychain -s ~/Library/Keychains/login.keychain-db

        # Add to search list
        security list-keychains -d user -s ~/Library/Keychains/login.keychain-db

        # Set timeout to avoid locking during build
        security set-keychain-settings -t 3600 ~/Library/Keychains/login.keychain-db || true

        # Show current keychain state
        echo "Default keychain:"
        security default-keychain -d user
        echo "Search list:"
        security list-keychains -d user

    - name: Create GoogleService-Info.plist
      working-directory: ios/PhotoSync
      run: |
        cat > GoogleService-Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
        	<key>API_KEY</key>
        	<string>AIzaSyD4xsNQMJjx3Pn33S4KZAPJOTHicB692pc</string>
        	<key>GCM_SENDER_ID</key>
        	<string>853497635030</string>
        	<key>PLIST_VERSION</key>
        	<string>1</string>
        	<key>BUNDLE_ID</key>
        	<string>com.morinclan.photosync.app</string>
        	<key>PROJECT_ID</key>
        	<string>photosync-5f3f7</string>
        	<key>STORAGE_BUCKET</key>
        	<string>photosync-5f3f7.firebasestorage.app</string>
        	<key>IS_ADS_ENABLED</key>
        	<false></false>
        	<key>IS_ANALYTICS_ENABLED</key>
        	<false></false>
        	<key>IS_APPINVITE_ENABLED</key>
        	<true></true>
        	<key>IS_GCM_ENABLED</key>
        	<true></true>
        	<key>IS_SIGNIN_ENABLED</key>
        	<true></true>
        	<key>GOOGLE_APP_ID</key>
        	<string>1:853497635030:ios:ccde3276a84d1e5b252977</string>
        </dict>
        </plist>
        EOF

    - name: Build and Upload to TestFlight
      working-directory: ios
      timeout-minutes: 45
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 180
        FASTLANE_XCODE_LIST_TIMEOUT: 180
      run: |
        set -x
        # Show what certificates are available
        security find-identity -v -p codesigning

        # Run fastlane with verbose output
        fastlane beta --verbose

    - name: Clean up API Key and Git Credentials
      if: always()
      run: |
        rm -f ~/.appstoreconnect/private_keys/AuthKey_*.p8
        rm -f ~/.git-credentials
        git config --global --unset credential.helper || true
        git config --global --unset url."https://github.com/".insteadOf || true

    - name: Discord Notification - Success
      if: success()
      env:
        BRANCH_NAME: ${{ github.ref_name }}
        REPO: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        COMMIT_SHA=${GITHUB_SHA:0:7}
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)

        curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "TestFlight Upload Successful",
              "description": "PhotoSync iOS app uploaded to TestFlight",
              "color": 3066993,
              "fields": [
                {
                  "name": "Branch",
                  "value": "'"$BRANCH_NAME"'",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "'"$COMMIT_SHA"'",
                  "inline": true
                },
                {
                  "name": "Workflow",
                  "value": "[View Run](https://github.com/'"$REPO"'/actions/runs/'"$RUN_ID"')",
                  "inline": false
                }
              ],
              "timestamp": "'"$TIMESTAMP"'"
            }]
          }' \
          "$DISCORD_WEBHOOK"

    - name: Discord Notification - Failure
      if: failure()
      env:
        BRANCH_NAME: ${{ github.ref_name }}
        REPO: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        COMMIT_SHA=${GITHUB_SHA:0:7}
        TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)

        curl -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "TestFlight Upload Failed",
              "description": "Failed to upload PhotoSync iOS app to TestFlight",
              "color": 15158332,
              "fields": [
                {
                  "name": "Branch",
                  "value": "'"$BRANCH_NAME"'",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "'"$COMMIT_SHA"'",
                  "inline": true
                },
                {
                  "name": "Workflow",
                  "value": "[View Run](https://github.com/'"$REPO"'/actions/runs/'"$RUN_ID"')",
                  "inline": false
                }
              ],
              "timestamp": "'"$TIMESTAMP"'"
            }]
          }' \
          "$DISCORD_WEBHOOK"
