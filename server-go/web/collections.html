<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collections - PhotoSync</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Theme Variables - Default: Purple Night */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: rgba(100, 116, 139, 0.2);
            --border-color-hover: rgba(100, 116, 139, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        /* Theme: Ocean Breeze */
        [data-theme="ocean"] {
            --bg-primary: #0a1628;
            --bg-secondary: #1a2942;
            --bg-tertiary: #2a3f5f;
            --accent-primary: #06b6d4;
            --accent-secondary: #0891b2;
            --text-primary: #ffffff;
            --text-secondary: #e0f2fe;
            --text-muted: #7dd3fc;
            --border-color: rgba(6, 182, 212, 0.2);
            --border-color-hover: rgba(6, 182, 212, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        /* Theme: Forest Green */
        [data-theme="forest"] {
            --bg-primary: #0c1e14;
            --bg-secondary: #1a2f23;
            --bg-tertiary: #2d4a3a;
            --accent-primary: #10b981;
            --accent-secondary: #059669;
            --text-primary: #ffffff;
            --text-secondary: #d1fae5;
            --text-muted: #6ee7b7;
            --border-color: rgba(16, 185, 129, 0.2);
            --border-color-hover: rgba(16, 185, 129, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        /* Theme: Sunset Orange */
        [data-theme="sunset"] {
            --bg-primary: #1c0f0a;
            --bg-secondary: #2d1810;
            --bg-tertiary: #4a2818;
            --accent-primary: #f97316;
            --accent-secondary: #ea580c;
            --text-primary: #ffffff;
            --text-secondary: #fed7aa;
            --text-muted: #fdba74;
            --border-color: rgba(249, 115, 22, 0.2);
            --border-color-hover: rgba(249, 115, 22, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        /* Theme: Rose Pink */
        [data-theme="rose"] {
            --bg-primary: #1f0a1a;
            --bg-secondary: #2f1629;
            --bg-tertiary: #4a253f;
            --accent-primary: #f43f5e;
            --accent-secondary: #e11d48;
            --text-primary: #ffffff;
            --text-secondary: #fecdd3;
            --text-muted: #fb7185;
            --border-color: rgba(244, 63, 94, 0.2);
            --border-color-hover: rgba(244, 63, 94, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        /* Theme: Midnight Blue */
        [data-theme="midnight"] {
            --bg-primary: #050a15;
            --bg-secondary: #0f1829;
            --bg-tertiary: #1a2942;
            --accent-primary: #3b82f6;
            --accent-secondary: #1d4ed8;
            --text-primary: #ffffff;
            --text-secondary: #dbeafe;
            --text-muted: #93c5fd;
            --border-color: rgba(59, 130, 246, 0.2);
            --border-color-hover: rgba(59, 130, 246, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: var(--font-family-base, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: var(--font-size-base, 16px);
            line-height: var(--line-height-normal, 1.5);
        }

        .navbar {
            background: var(--bg-secondary);
            padding: var(--spacing-md, 12px) var(--spacing-lg, 24px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md, 0 2px 8px rgba(0, 0, 0, 0.4));
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: var(--spacing-md, 16px);
        }

        .navbar-brand h1 {
            font-size: var(--font-size-xl, 20px);
            font-weight: var(--font-weight-semibold, 600);
        }

        .back-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            padding: var(--spacing-sm, 8px) var(--spacing-md, 12px);
            border-radius: var(--border-radius-md, 6px);
            cursor: pointer;
            font-size: var(--font-size-sm, 14px);
            text-decoration: none;
            transition: var(--transition-normal, all 0.3s ease);
        }

        .back-btn:hover {
            background: var(--bg-tertiary-hover, rgba(71, 85, 105, 0.8));
            transform: var(--hover-scale, translateY(-1px));
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md, 12px);
        }

        .user-name {
            font-size: var(--font-size-sm, 14px);
            color: var(--text-muted);
        }

        .logout-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            padding: var(--spacing-sm, 8px) var(--spacing-md, 16px);
            border-radius: var(--border-radius-md, 6px);
            cursor: pointer;
            font-size: var(--font-size-sm, 14px);
            transition: var(--transition-normal, all 0.3s ease);
        }

        .logout-btn:hover {
            background: var(--bg-tertiary-hover, rgba(71, 85, 105, 0.8));
        }

        .container {
            max-width: var(--max-width-container, 1400px);
            margin: 0 auto;
            padding: var(--spacing-lg, 24px);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg, 24px);
        }

        .page-title {
            font-size: var(--font-size-3xl, 28px);
            font-weight: var(--font-weight-semibold, 600);
        }

        .create-btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            border: none;
            padding: var(--spacing-md, 12px) var(--spacing-lg, 24px);
            border-radius: var(--border-radius-lg, 8px);
            cursor: pointer;
            font-size: var(--font-size-base, 16px);
            font-weight: var(--font-weight-medium, 500);
            transition: var(--transition-normal, all 0.3s ease);
        }

        .create-btn:hover {
            transform: var(--hover-scale, translateY(-2px));
            box-shadow: var(--shadow-lg, 0 4px 12px rgba(102, 126, 234, 0.4));
        }

        .section-title {
            font-size: var(--font-size-lg, 18px);
            font-weight: var(--font-weight-medium, 500);
            margin-bottom: var(--spacing-md, 16px);
            color: var(--text-muted);
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--grid-cols-min, 300px), 1fr));
            gap: var(--grid-gap, 20px);
            margin-bottom: var(--spacing-2xl, 40px);
        }

        .collection-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-xl, 12px);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-normal, all 0.3s ease);
        }

        .collection-card:hover {
            transform: var(--hover-scale, translateY(-4px));
            box-shadow: var(--shadow-xl, 0 10px 40px rgba(0, 0, 0, 0.4));
        }

        .collection-cover {
            height: 180px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .collection-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .collection-cover .no-cover {
            font-size: 48px;
            color: rgba(71, 85, 105, 0.6);
        }

        .collection-info {
            padding: var(--spacing-md, 16px);
        }

        .collection-name {
            font-size: var(--font-size-lg, 18px);
            font-weight: var(--font-weight-semibold, 600);
            margin-bottom: var(--spacing-sm, 8px);
        }

        .collection-meta {
            display: flex;
            gap: var(--spacing-md, 16px);
            color: var(--text-muted);
            font-size: var(--font-size-sm, 14px);
        }

        .collection-visibility {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs, 4px);
            padding: var(--spacing-xs, 4px) var(--spacing-sm, 8px);
            background: var(--bg-tertiary);
            border-radius: var(--border-radius-sm, 4px);
            font-size: var(--font-size-xs, 12px);
            text-transform: uppercase;
        }

        .visibility-private { color: var(--text-muted); }
        .visibility-shared { color: var(--accent-primary); }
        .visibility-secret_link { color: #f59e0b; }
        .visibility-public { color: #10b981; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--border-radius-2xl, 16px);
            width: 100%;
            max-width: var(--max-width-modal, 600px);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: var(--spacing-lg, 20px) var(--spacing-lg, 24px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-xl, 20px);
            font-weight: var(--font-weight-semibold, 600);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: var(--font-size-2xl, 24px);
            cursor: pointer;
            transition: var(--transition-fast, all 0.15s ease);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg, 24px);
        }

        .form-group {
            margin-bottom: var(--spacing-lg, 20px);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm, 8px);
            font-size: var(--font-size-sm, 14px);
            color: var(--text-muted);
            font-weight: var(--font-weight-medium, 500);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: var(--spacing-md, 12px);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg, 8px);
            color: var(--text-primary);
            font-size: var(--font-size-sm, 14px);
            font-family: var(--font-family-base, inherit);
            transition: var(--transition-fast, all 0.15s ease);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--border-focus, rgba(102, 126, 234, 0.1));
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            line-height: var(--line-height-relaxed, 1.75);
        }

        .theme-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-sm, 8px);
        }

        .theme-option {
            padding: var(--spacing-sm, 8px);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg, 8px);
            cursor: pointer;
            text-align: center;
            transition: var(--transition-fast, all 0.15s ease);
        }

        .theme-option:hover {
            border-color: var(--border-color-hover, rgba(100, 116, 139, 0.4));
        }

        .theme-option.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px var(--accent-primary);
        }

        .theme-preview {
            height: 40px;
            border-radius: var(--border-radius-sm, 4px);
            margin-bottom: var(--spacing-sm, 8px);
        }

        .theme-name {
            font-size: var(--font-size-xs, 12px);
            color: var(--text-muted);
        }

        .modal-footer {
            padding: var(--spacing-md, 16px) var(--spacing-lg, 24px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md, 12px);
        }

        .btn {
            padding: var(--spacing-sm, 10px) var(--spacing-lg, 20px);
            border-radius: var(--border-radius-lg, 8px);
            font-size: var(--font-size-sm, 14px);
            cursor: pointer;
            border: none;
            font-weight: var(--font-weight-medium, 500);
            transition: var(--transition-normal, all 0.3s ease);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary-hover, rgba(71, 85, 105, 0.8));
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: var(--hover-scale, translateY(-1px));
            box-shadow: var(--shadow-lg, 0 4px 12px rgba(102, 126, 234, 0.4));
        }

        .btn-danger {
            background: var(--color-error, #ef4444);
            color: white;
        }

        .btn-danger:hover {
            background: var(--color-error-dark, #dc2626);
        }

        /* Collection Detail View */
        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: block;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-title {
            font-size: var(--font-size-4xl, 32px);
            font-weight: var(--font-weight-semibold, 600);
            margin-bottom: var(--spacing-sm, 8px);
        }

        .detail-description {
            color: var(--text-muted);
            margin-bottom: var(--spacing-md, 16px);
            line-height: var(--line-height-relaxed, 1.75);
        }

        .detail-actions {
            display: flex;
            gap: var(--spacing-md, 12px);
        }

        .share-info {
            background: #334155;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .share-url {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .share-url input {
            flex: 1;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .photos-section {
            margin-top: 24px;
        }

        .photos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--grid-cols-min, 180px), 1fr));
            gap: var(--grid-gap, 8px);
        }

        .photo-item {
            aspect-ratio: var(--grid-card-aspect-ratio, 1);
            background: var(--bg-secondary);
            border-radius: var(--border-radius-lg, 8px);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: var(--transition-normal, all 0.3s ease);
        }

        .photo-item:hover {
            transform: var(--hover-scale, scale(1.02));
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            font-size: 16px;
        }

        .photo-item:hover .photo-remove {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        /* Shares Section */
        .shares-section {
            margin-top: 24px;
        }

        .share-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .share-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .share-avatar {
            width: 36px;
            height: 36px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .add-share-form {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            display: none;
            z-index: 2000;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.active {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/" class="back-btn">&#8592; Gallery</a>
            <h1>Collections</h1>
        </div>
        <div class="navbar-user">
            <span class="user-name" id="userName"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- List View -->
        <div id="listView">
            <div class="page-header">
                <h2 class="page-title">Your Collections</h2>
                <button class="create-btn" onclick="showCreateModal()">+ New Collection</button>
            </div>

            <div id="ownedSection">
                <h3 class="section-title">My Collections</h3>
                <div class="collections-grid" id="ownedCollections">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading collections...
                    </div>
                </div>
            </div>

            <div id="sharedSection" style="display: none;">
                <h3 class="section-title">Shared with Me</h3>
                <div class="collections-grid" id="sharedCollections"></div>
            </div>
        </div>

        <!-- Detail View -->
        <div id="detailView" class="detail-view">
            <a href="javascript:showListView()" class="back-btn" style="margin-bottom: 20px; display: inline-block;">&#8592; Back to Collections</a>

            <div class="detail-header">
                <div>
                    <h1 class="detail-title" id="detailName"></h1>
                    <p class="detail-description" id="detailDescription"></p>
                    <div class="collection-meta">
                        <span class="collection-visibility" id="detailVisibility"></span>
                        <span id="detailPhotoCount">0 photos</span>
                    </div>
                </div>
                <div class="detail-actions" id="ownerActions">
                    <button class="btn btn-secondary" onclick="showEditModal()">Edit</button>
                    <button class="btn btn-secondary" onclick="showShareModal()">Share</button>
                    <button class="btn btn-danger" onclick="deleteCollection()">Delete</button>
                </div>
            </div>

            <div class="share-info" id="shareInfo" style="display: none;">
                <strong>Share Link</strong>
                <div class="share-url">
                    <input type="text" id="shareUrl" readonly>
                    <button class="copy-btn" onclick="copyShareUrl()">Copy</button>
                </div>
            </div>

            <div class="photos-section">
                <div class="photos-header">
                    <h3 class="section-title">Photos</h3>
                </div>
                <div class="photo-grid" id="collectionPhotos"></div>
            </div>

            <div class="shares-section" id="sharesSection" style="display: none;">
                <h3 class="section-title">Shared With</h3>
                <div id="sharesList"></div>
                <div class="add-share-form">
                    <input type="email" id="shareEmail" placeholder="Enter email to share" class="form-input" style="flex: 1;">
                    <button class="btn btn-primary" onclick="addShare()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal-overlay" id="collectionModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">New Collection</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="collectionName" class="form-input" placeholder="My Collection">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="collectionDescription" class="form-textarea" placeholder="Optional description..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Custom Slug (optional)</label>
                    <input type="text" id="collectionSlug" class="form-input" placeholder="my-collection">
                    <small style="color: #64748b; font-size: 12px;">Leave empty for auto-generated slug</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <select id="themeSource" class="form-select" onchange="toggleThemeSelector()" style="margin-bottom: 12px;">
                        <option value="inherit">Use my default theme (inherits from your global preference)</option>
                        <option value="explicit">Custom theme for this collection</option>
                    </select>
                    <div class="theme-selector" id="themeSelector" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Custom CSS (optional)</label>
                    <textarea id="collectionCSS" class="form-textarea" placeholder="/* Add custom styles */"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalSaveBtn" onclick="saveCollection()">Create</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Share Settings</h2>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Visibility</label>
                    <select id="visibilitySelect" class="form-select" onchange="updateVisibility()">
                        <option value="private">Private - Only you can see</option>
                        <option value="shared">Shared - Specific users only</option>
                        <option value="secret_link">Secret Link - Anyone with the link</option>
                        <option value="public">Public - Anyone can discover</option>
                    </select>
                </div>
                <div id="secretLinkSection" style="display: none; margin-top: 16px;">
                    <label class="form-label">Secret Link</label>
                    <div class="share-url">
                        <input type="text" id="secretLinkUrl" readonly class="form-input">
                        <button class="copy-btn" onclick="copySecretLink()">Copy</button>
                    </div>
                </div>
                <div id="publicLinkSection" style="display: none; margin-top: 16px;">
                    <label class="form-label">Public URL</label>
                    <div class="share-url">
                        <input type="text" id="publicUrl" readonly class="form-input">
                        <button class="copy-btn" onclick="copyPublicUrl()">Copy</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Theme initialization with dynamic loading
        let currentThemeId = null;

        async function loadThemeCSS(themeId) {
            try {
                const response = await fetch(`/api/themes/${themeId}/css`);
                if (!response.ok) {
                    console.error('Failed to load theme CSS');
                    return;
                }

                const css = await response.text();

                // Remove old dynamic theme
                const oldStyle = document.getElementById('dynamic-theme');
                if (oldStyle) {
                    oldStyle.remove();
                }

                // Inject new theme CSS
                const style = document.createElement('style');
                style.id = 'dynamic-theme';
                style.textContent = css;
                document.head.appendChild(style);

                currentThemeId = themeId;
            } catch (error) {
                console.error('Failed to load theme CSS:', error);
            }
        }

        async function initTheme() {
            try {
                // Try to get user's global theme preference
                const response = await fetch('/api/users/me/preferences', {
                    credentials: 'include'
                });

                let themeId = 'dark'; // Default fallback

                if (response.ok) {
                    const prefs = await response.json();
                    if (prefs.globalThemeId) {
                        themeId = prefs.globalThemeId;
                    }
                }

                await loadThemeCSS(themeId);
            } catch (error) {
                console.error('Failed to initialize theme:', error);
                // Load default theme as fallback
                await loadThemeCSS('dark');
            }
        }

        // Initialize theme on page load
        initTheme();

        let currentUser = null;
        let collections = { owned: [], shared: [] };
        let currentCollection = null;
        let editingCollection = null;
        let themes = [];

        // Initialize
        async function init() {
            loadAppInfo();
            await checkSession();
            await loadThemes();
            await loadCollections();
        }

        async function loadAppInfo() {
            try {
                const res = await fetch('/api/info');
                if (res.ok) {
                    const data = await res.json();
                    if (data.appName) {
                        document.title = 'Collections - ' + data.appName;
                    }
                }
            } catch (error) {
                console.log('Could not load app info:', error);
            }
        }

        async function checkSession() {
            try {
                const response = await fetch('/api/web/session');
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const data = await response.json();
                currentUser = data.user;
                document.getElementById('userName').textContent = currentUser.displayName;
            } catch (error) {
                window.location.href = '/login.html';
            }
        }

        async function loadThemes() {
            try {
                const response = await fetch('/api/themes');
                if (!response.ok) {
                    console.error('Failed to load themes');
                    return;
                }
                themes = await response.json();
                renderThemeSelector();
            } catch (error) {
                console.error('Failed to load themes:', error);
            }
        }

        function renderThemeSelector() {
            const container = document.getElementById('themeSelector');

            // Clear existing content safely
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            // Create theme options using safe DOM methods
            themes.forEach(theme => {
                const option = document.createElement('div');
                option.className = 'theme-option';
                option.setAttribute('data-theme', theme.id);
                option.onclick = () => selectTheme(theme.id);

                const preview = document.createElement('div');
                preview.className = 'theme-preview';
                preview.style.background = getThemePreviewColor(theme);

                const name = document.createElement('div');
                name.className = 'theme-name';
                name.textContent = theme.name;

                option.appendChild(preview);
                option.appendChild(name);
                container.appendChild(option);
            });

            // Select default theme
            if (themes.length > 0) {
                selectTheme('dark');
            }
        }

        function getThemePreviewColor(theme) {
            // Try to extract a preview color from theme properties
            // For now, use a simple gradient based on theme ID
            const colorMap = {
                'dark': '#667eea',
                'light': '#e2e8f0',
                'minimal': '#94a3b8',
                'gallery': '#06b6d4',
                'magazine': '#f43f5e'
            };
            return colorMap[theme.id] || '#667eea';
        }

        function toggleThemeSelector() {
            const themeSource = document.getElementById('themeSource').value;
            const themeSelector = document.getElementById('themeSelector');

            if (themeSource === 'explicit') {
                themeSelector.style.display = 'grid';
            } else {
                themeSelector.style.display = 'none';
            }
        }

        function selectTheme(themeId) {
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.theme-option[data-theme="${themeId}"]`)?.classList.add('selected');
        }

        function getSelectedTheme() {
            return document.querySelector('.theme-option.selected')?.dataset.theme || 'dark';
        }

        async function loadCollections() {
            try {
                const response = await fetch('/api/web/collections');
                if (!response.ok) throw new Error('Failed to load collections');
                collections = await response.json();
                renderCollections();
            } catch (error) {
                console.error('Failed to load collections:', error);
                showToast('Failed to load collections', true);
            }
        }

        function renderCollections() {
            const ownedContainer = document.getElementById('ownedCollections');
            const sharedContainer = document.getElementById('sharedCollections');
            const sharedSection = document.getElementById('sharedSection');

            if (collections.owned.length === 0) {
                ownedContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>No collections yet</h3>
                        <p>Create your first collection to organize and share your photos</p>
                    </div>
                `;
            } else {
                ownedContainer.innerHTML = collections.owned.map(c => renderCollectionCard(c)).join('');
            }

            if (collections.shared.length > 0) {
                sharedSection.style.display = 'block';
                sharedContainer.innerHTML = collections.shared.map(c => renderCollectionCard(c)).join('');
            } else {
                sharedSection.style.display = 'none';
            }
        }

        function renderCollectionCard(collection) {
            const coverImg = collection.coverPhotoId
                ? `<img src="/api/web/photos/${collection.coverPhotoId}/thumbnail?size=medium" alt="">`
                : '<span class="no-cover">&#128247;</span>';

            return `
                <div class="collection-card" onclick="openCollection('${collection.id}')">
                    <div class="collection-cover">${coverImg}</div>
                    <div class="collection-info">
                        <div class="collection-name">${escapeHtml(collection.name)}</div>
                        <div class="collection-meta">
                            <span class="collection-visibility visibility-${collection.visibility}">${collection.visibility}</span>
                            <span>${collection.photoCount} photos</span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function openCollection(id) {
            try {
                const response = await fetch(`/api/web/collections/${id}`);
                if (!response.ok) throw new Error('Failed to load collection');
                const data = await response.json();
                currentCollection = data.collection;
                renderDetailView(data);
            } catch (error) {
                console.error('Failed to open collection:', error);
                showToast('Failed to load collection', true);
            }
        }

        function renderDetailView(data) {
            const { collection, photos, shares } = data;

            document.getElementById('listView').style.display = 'none';
            document.getElementById('detailView').classList.add('active');

            document.getElementById('detailName').textContent = collection.name;
            document.getElementById('detailDescription').textContent = collection.description || '';
            document.getElementById('detailVisibility').textContent = collection.visibility;
            document.getElementById('detailVisibility').className = `collection-visibility visibility-${collection.visibility}`;
            document.getElementById('detailPhotoCount').textContent = `${photos?.length || 0} photos`;

            // Show/hide owner actions
            const isOwner = collection.isOwner;
            document.getElementById('ownerActions').style.display = isOwner ? 'flex' : 'none';
            document.getElementById('sharesSection').style.display = isOwner ? 'block' : 'none';

            // Share info
            const shareInfo = document.getElementById('shareInfo');
            if (collection.visibility === 'public') {
                shareInfo.style.display = 'block';
                document.getElementById('shareUrl').value = `${window.location.origin}/gallery/${collection.slug}`;
            } else if (collection.visibility === 'secret_link' && collection.secretToken) {
                shareInfo.style.display = 'block';
                document.getElementById('shareUrl').value = `${window.location.origin}/gallery/s/${collection.secretToken}`;
            } else {
                shareInfo.style.display = 'none';
            }

            // Render photos
            const photosContainer = document.getElementById('collectionPhotos');
            if (photos && photos.length > 0) {
                photosContainer.innerHTML = photos.map(p => `
                    <div class="photo-item">
                        <img src="/api/web/photos/${p.photo?.id || p.id}/thumbnail?size=medium" alt="">
                        ${isOwner ? `<button class="photo-remove" onclick="removePhoto(event, '${p.photo?.id || p.id}')">x</button>` : ''}
                    </div>
                `).join('');
            } else {
                photosContainer.innerHTML = '<p style="color: #94a3b8; padding: 20px;">No photos in this collection yet</p>';
            }

            // Render shares
            if (isOwner && shares) {
                renderShares(shares);
            }
        }

        function renderShares(shares) {
            const container = document.getElementById('sharesList');
            if (shares.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8;">Not shared with anyone yet</p>';
                return;
            }

            container.innerHTML = shares.map(s => `
                <div class="share-item">
                    <div class="share-user">
                        <div class="share-avatar">${s.user?.displayName?.[0]?.toUpperCase() || '?'}</div>
                        <div>
                            <div>${escapeHtml(s.user?.displayName || 'Unknown')}</div>
                            <div style="color: #64748b; font-size: 12px;">${escapeHtml(s.user?.email || '')}</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;"
                            onclick="removeShare('${s.userId}')">Remove</button>
                </div>
            `).join('');
        }

        function showListView() {
            document.getElementById('detailView').classList.remove('active');
            document.getElementById('listView').style.display = 'block';
            currentCollection = null;
            loadCollections();
        }

        function showCreateModal() {
            editingCollection = null;
            document.getElementById('modalTitle').textContent = 'New Collection';
            document.getElementById('modalSaveBtn').textContent = 'Create';
            document.getElementById('collectionName').value = '';
            document.getElementById('collectionDescription').value = '';
            document.getElementById('collectionSlug').value = '';
            document.getElementById('collectionCSS').value = '';
            document.getElementById('themeSource').value = 'inherit';
            toggleThemeSelector();
            selectTheme('dark');
            document.getElementById('collectionModal').classList.add('active');
        }

        function showEditModal() {
            if (!currentCollection) return;
            editingCollection = currentCollection;
            document.getElementById('modalTitle').textContent = 'Edit Collection';
            document.getElementById('modalSaveBtn').textContent = 'Save';
            document.getElementById('collectionName').value = currentCollection.name;
            document.getElementById('collectionDescription').value = currentCollection.description || '';
            document.getElementById('collectionSlug').value = currentCollection.slug;
            document.getElementById('collectionCSS').value = currentCollection.customCss || '';

            // Set theme source and theme
            const themeSource = currentCollection.themeSource || 'explicit';
            document.getElementById('themeSource').value = themeSource;
            toggleThemeSelector();

            if (themeSource === 'explicit') {
                selectTheme(currentCollection.theme || 'dark');
            }

            document.getElementById('collectionModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('collectionModal').classList.remove('active');
            editingCollection = null;
        }

        async function saveCollection() {
            const name = document.getElementById('collectionName').value.trim();
            if (!name) {
                showToast('Name is required', true);
                return;
            }

            const themeSource = document.getElementById('themeSource').value;

            const data = {
                name,
                description: document.getElementById('collectionDescription').value.trim() || null,
                slug: document.getElementById('collectionSlug').value.trim() || null,
                themeSource: themeSource,
                theme: themeSource === 'explicit' ? getSelectedTheme() : 'dark',
                customCss: document.getElementById('collectionCSS').value.trim() || null
            };

            try {
                let response;
                if (editingCollection) {
                    response = await fetch(`/api/web/collections/${editingCollection.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/api/web/collections', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                closeModal();
                showToast(editingCollection ? 'Collection updated' : 'Collection created');

                if (editingCollection && currentCollection) {
                    openCollection(currentCollection.id);
                } else {
                    loadCollections();
                }
            } catch (error) {
                showToast(error.message || 'Failed to save collection', true);
            }
        }

        async function deleteCollection() {
            if (!currentCollection || !confirm('Delete this collection? This cannot be undone.')) return;

            try {
                const response = await fetch(`/api/web/collections/${currentCollection.id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete');
                showToast('Collection deleted');
                showListView();
            } catch (error) {
                showToast('Failed to delete collection', true);
            }
        }

        async function removePhoto(event, photoId) {
            event.stopPropagation();
            if (!currentCollection || !confirm('Remove this photo from the collection?')) return;

            try {
                const response = await fetch(`/api/web/collections/${currentCollection.id}/photos`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoIds: [photoId] })
                });
                if (!response.ok) throw new Error('Failed to remove');
                showToast('Photo removed');
                openCollection(currentCollection.id);
            } catch (error) {
                showToast('Failed to remove photo', true);
            }
        }

        function showShareModal() {
            if (!currentCollection) return;
            document.getElementById('visibilitySelect').value = currentCollection.visibility;
            updateVisibilityUI();
            document.getElementById('shareModal').classList.add('active');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        async function updateVisibility() {
            const visibility = document.getElementById('visibilitySelect').value;

            try {
                const response = await fetch(`/api/web/collections/${currentCollection.id}/visibility`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ visibility })
                });
                if (!response.ok) throw new Error('Failed to update');
                currentCollection = await response.json();
                updateVisibilityUI();
                showToast('Visibility updated');
            } catch (error) {
                showToast('Failed to update visibility', true);
            }
        }

        function updateVisibilityUI() {
            const visibility = currentCollection.visibility;
            document.getElementById('secretLinkSection').style.display =
                visibility === 'secret_link' ? 'block' : 'none';
            document.getElementById('publicLinkSection').style.display =
                visibility === 'public' ? 'block' : 'none';

            if (visibility === 'secret_link' && currentCollection.secretToken) {
                document.getElementById('secretLinkUrl').value =
                    `${window.location.origin}/gallery/s/${currentCollection.secretToken}`;
            }
            if (visibility === 'public') {
                document.getElementById('publicUrl').value =
                    `${window.location.origin}/gallery/${currentCollection.slug}`;
            }
        }

        async function addShare() {
            const email = document.getElementById('shareEmail').value.trim();
            if (!email || !currentCollection) return;

            try {
                const response = await fetch(`/api/web/collections/${currentCollection.id}/shares`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emails: [email] })
                });
                if (!response.ok) throw new Error('Failed to share');
                const result = await response.json();
                if (result.failedEmails?.length > 0) {
                    showToast('User not found: ' + result.failedEmails.join(', '), true);
                } else {
                    showToast('Shared successfully');
                    document.getElementById('shareEmail').value = '';
                    openCollection(currentCollection.id);
                }
            } catch (error) {
                showToast('Failed to share', true);
            }
        }

        async function removeShare(userId) {
            if (!currentCollection || !confirm('Remove this share?')) return;

            try {
                const response = await fetch(`/api/web/collections/${currentCollection.id}/shares/${userId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to remove');
                showToast('Share removed');
                openCollection(currentCollection.id);
            } catch (error) {
                showToast('Failed to remove share', true);
            }
        }

        function copyShareUrl() {
            const input = document.getElementById('shareUrl');
            input.select();
            document.execCommand('copy');
            showToast('Link copied!');
        }

        function copySecretLink() {
            const input = document.getElementById('secretLinkUrl');
            input.select();
            document.execCommand('copy');
            showToast('Secret link copied!');
        }

        function copyPublicUrl() {
            const input = document.getElementById('publicUrl');
            input.select();
            document.execCommand('copy');
            showToast('Public URL copied!');
        }

        async function logout() {
            try {
                await fetch('/api/web/auth/logout', { method: 'POST' });
            } catch (e) {}
            window.location.href = '/login.html';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast active' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
