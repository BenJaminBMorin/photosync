<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoSync Gallery</title>
    <!-- Leaflet CSS for map view -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Theme CSS loaded dynamically from API */
        /* Default fallback styles (will be replaced by actual theme) */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-tertiary-hover: #475569;
            --bg-secondary-alpha: rgba(30, 41, 59, 0.98);
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: rgba(100, 116, 139, 0.2);
            --border-color-hover: rgba(100, 116, 139, 0.4);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-dark: rgba(0, 0, 0, 0.4);
            --overlay-bg: rgba(30, 41, 59, 0.98);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: var(--spacing-md, 16px) var(--spacing-xl, 32px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg, 0 4px 20px rgba(0,0,0,0.4));
            backdrop-filter: blur(var(--blur-md, 10px));
            border-bottom: 1px solid var(--border-color, var(--border-color));
        }

        .navbar-brand {
            font-size: var(--font-size-2xl, 24px);
            font-weight: var(--font-weight-bold, 700);
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: var(--letter-spacing-tight, -0.5px);
        }

        .navbar-controls {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .view-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .view-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 10px 14px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            position: relative;
        }

        .view-btn.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }

        .view-btn:hover:not(.active) {
            background: var(--bg-tertiary-hover);
            color: var(--text-secondary);
            transform: translateY(-1px);
        }

        .navbar-user {
            position: relative;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .user-menu-btn:hover {
            background: var(--bg-tertiary-hover);
            border-color: var(--border-color-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-light, rgba(0, 0, 0, 0.2));
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-name {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .user-menu-icon {
            color: var(--text-muted);
            font-size: 12px;
            transition: transform 0.3s;
        }

        .user-menu-btn.active .user-menu-icon {
            transform: rotate(180deg);
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-secondary-alpha);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            min-width: 220px;
            box-shadow: 0 8px 32px var(--shadow-dark);
            backdrop-filter: blur(20px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .dropdown-item:hover {
            background: var(--bg-tertiary-hover);
        }

        .dropdown-item-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .theme-selector {
            padding: 8px 12px;
            position: relative;
        }

        .theme-dropdown-btn {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            font-size: 14px;
        }

        .theme-dropdown-btn:hover {
            background: var(--bg-tertiary-hover);
            border-color: var(--border-color-hover);
        }

        .theme-dropdown-current {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-preview-mini {
            width: 40px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .theme-dropdown-arrow {
            color: var(--text-muted);
            font-size: 10px;
            transition: transform 0.2s;
        }

        .theme-dropdown-btn.open .theme-dropdown-arrow {
            transform: rotate(180deg);
        }

        .theme-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 12px;
            right: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 24px var(--shadow-dark, rgba(0, 0, 0, 0.4));
            z-index: 1000;
            display: none;
        }

        .theme-dropdown-menu.open {
            display: block;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: var(--text-primary);
        }

        .theme-option:hover {
            background: var(--bg-tertiary-hover);
        }

        .theme-option.active {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-primary);
        }

        .theme-option:first-child {
            border-radius: 8px 8px 0 0;
        }

        .theme-option:last-child {
            border-radius: 0 0 8px 8px;
        }

        .theme-preview {
            width: 50px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .theme-option-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .theme-option-name {
            font-size: 14px;
            font-weight: 500;
        }

        .theme-option-description {
            font-size: 12px;
            color: var(--text-muted);
        }

        .select-mode-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .select-mode-btn:hover {
            background: var(--bg-tertiary-hover);
            border-color: var(--border-color-hover);
            color: var(--text-secondary);
        }

        .select-mode-btn.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .gallery-header {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .gallery-stats {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Skeleton Loader Animation */
        @keyframes skeleton-pulse {
            0%, 100% { background-color: var(--bg-tertiary); }
            50% { background-color: var(--bg-tertiary-hover, #475569); }
        }

        .skeleton {
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        .photo-skeleton {
            aspect-ratio: 1;
            border-radius: 4px;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        .skeleton-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 4px;
            padding: 4px;
        }

        /* Month Headers */
        .month-header {
            grid-column: 1 / -1;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary, #f8fafc);
            padding: 24px 8px 12px 8px;
            margin-top: 16px;
        }

        .month-header:first-child {
            margin-top: 0;
        }

        /* Grid View */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 28px 4px;
            padding: 4px;
        }

        .photo-grid.large {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 32px 8px;
            padding: 8px;
        }

        .photo-item {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            overflow: hidden;
            cursor: pointer;
            position: relative;
            contain: layout style;
        }

        .photo-grid {
            contain: layout style;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .photo-item img.loaded {
            opacity: 1;
        }

        .photo-item .skeleton-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
        }

        .photo-item .skeleton-placeholder.loading {
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        .photo-item:hover {
            transform: scale(1.02);
            z-index: 1;
        }

        /* Selection Mode - use visibility for instant toggle */
        .photo-item .select-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            background: rgba(0,0,0,0.5);
            border: 2px solid white;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            z-index: 5;
            visibility: hidden;
            opacity: 0;
            display: flex;
            contain: strict;
        }

        .select-mode .photo-item .select-checkbox {
            visibility: visible;
            opacity: 1;
        }

        .select-mode .photo-item:hover {
            transform: none;
        }

        .photo-item.selected .select-checkbox {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .photo-item.selected .select-checkbox::after {
            content: '✓';
        }

        /* Selection overlay as a child element instead of pseudo-element */
        .photo-item .selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.3);
            pointer-events: none;
            visibility: hidden;
            opacity: 0;
        }

        .photo-item.selected .selection-overlay {
            visibility: visible;
            opacity: 1;
        }

        /* Selection Action Bar */
        .selection-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            padding: 16px 24px;
            display: none;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 200;
        }

        .selection-bar.active {
            display: flex;
        }

        .selection-info {
            font-size: 16px;
            font-weight: 500;
        }

        .selection-actions {
            display: flex;
            gap: 12px;
        }

        .selection-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .selection-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .selection-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .selection-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .selection-btn.secondary:hover {
            background: var(--bg-tertiary-hover);
            border-color: var(--border-color-hover);
        }

        .selection-btn.danger {
            background: var(--color-error, var(--semantic-error, #ef4444));
            color: white;
        }

        .selection-btn.danger:hover {
            background: var(--color-error-dark, #dc2626);
        }

        .selection-btn.danger:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Bulk Delete Modal */
        .bulk-delete-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-black, rgba(0, 0, 0, 0.8));
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .bulk-delete-modal.active {
            display: flex;
        }

        .bulk-delete-modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .bulk-delete-stage h3 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .bulk-delete-warning {
            color: var(--semantic-error-light, #f87171);
            margin-bottom: 24px;
        }

        .bulk-delete-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .bulk-delete-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .bulk-delete-btn.cancel {
            background: var(--bg-tertiary);
            color: white;
        }

        .bulk-delete-btn.cancel:hover {
            background: var(--bg-tertiary-hover, #475569);
        }

        .bulk-delete-btn.confirm {
            background: var(--semantic-error, #ef4444);
            color: white;
        }

        .bulk-delete-btn.confirm:hover {
            background: var(--semantic-error-dark, #dc2626);
        }

        .bulk-delete-pending-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .bulk-delete-timer {
            color: var(--text-muted);
            margin: 16px 0;
        }

        .bulk-delete-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .bulk-delete-success-icon {
            font-size: 48px;
            color: var(--semantic-success);
            margin-bottom: 16px;
        }

        .bulk-delete-denied-icon {
            font-size: 48px;
            color: var(--semantic-error);
            margin-bottom: 16px;
        }

        .bulk-delete-error-icon {
            font-size: 48px;
            color: var(--semantic-warning, #f59e0b);
            margin-bottom: 16px;
        }

        /* Select Mode Toggle */
        .select-mode-btn {
            background: var(--bg-tertiary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .select-mode-btn:hover {
            background: var(--bg-tertiary-hover, #475569);
        }

        .select-mode-btn.active {
            background: var(--accent-primary);
        }

        .photo-item .photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: linear-gradient(transparent, var(--overlay-black, var(--overlay-black, rgba(0,0,0,0.8))));
            font-size: 11px;
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-item:hover .photo-overlay {
            opacity: 1;
        }

        .photo-item .photo-date-label {
            position: absolute;
            bottom: -22px;
            left: 0;
            right: 0;
            padding: 4px 8px;
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* List View */
        .photo-list {
            display: flex;
            flex-direction: column;
        }

        .photo-list .photo-item {
            aspect-ratio: auto;
            display: flex;
            align-items: flex-start;
            padding: 16px 24px;
            border-bottom: 1px solid var(--bg-tertiary);
            gap: 20px;
        }

        .photo-list .photo-item:hover {
            background: var(--bg-secondary);
            transform: none;
        }

        .photo-list .photo-item img {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            flex-shrink: 0;
            object-fit: cover;
        }

        .photo-list .photo-item .skeleton-placeholder {
            width: 100px;
            height: 100px;
            position: relative;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .photo-list .photo-info {
            flex: 1;
            min-width: 0;
        }

        .photo-list .photo-filename {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .photo-list .photo-meta {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px 24px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .photo-list .meta-item {
            display: flex;
            gap: 8px;
        }

        .photo-list .meta-label {
            color: var(--text-disabled, #64748b);
            min-width: 80px;
        }

        .photo-list .meta-value {
            color: var(--text-secondary);
        }

        .photo-list .meta-link {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .photo-list .meta-link:hover {
            text-decoration: underline;
        }

        .photo-list .photo-overlay {
            display: none;
        }

        .photo-list .photo-date-label {
            display: none;
        }

        .photo-list .month-header {
            display: none;
        }

        /* Carousel View */
        .carousel-container {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 50;
        }

        .carousel-container.active {
            display: flex;
            flex-direction: column;
        }

        .carousel-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .carousel-image-wrapper {
            max-width: 90%;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-image {
            max-width: 100%;
            max-height: calc(100vh - 200px);
            object-fit: contain;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 48px;
            cursor: pointer;
            padding: 20px;
            border-radius: 50%;
            z-index: 10;
        }

        .carousel-nav:hover {
            background: rgba(255,255,255,0.2);
        }

        .carousel-prev { left: 20px; }
        .carousel-next { right: 20px; }

        .carousel-info {
            background: var(--bg-secondary);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .carousel-meta {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .carousel-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .carousel-btn {
            background: var(--bg-tertiary);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .carousel-btn.active {
            background: var(--accent-primary);
        }

        .carousel-progress {
            height: 4px;
            background: var(--bg-tertiary);
            position: relative;
        }

        .carousel-progress-bar {
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.3s;
        }

        .carousel-strip {
            height: 100px;
            background: var(--bg-secondary);
            display: flex;
            overflow-x: auto;
            gap: 4px;
            padding: 8px;
            scroll-behavior: smooth;
        }

        .carousel-strip::-webkit-scrollbar {
            height: 6px;
        }

        .carousel-strip::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .carousel-strip::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary-hover, #475569);
            border-radius: 3px;
        }

        .carousel-thumb {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
        }

        .carousel-thumb.active {
            opacity: 1;
            border: 2px solid var(--accent-primary);
        }

        .carousel-thumb:hover {
            opacity: 0.8;
        }

        /* Map View */
        .map-container {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
        }

        .map-container.active {
            display: block;
        }

        #photo-map {
            width: 100%;
            height: 100%;
        }

        .map-popup-thumb {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        .map-popup-info {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-inverse, #333);
        }

        .leaflet-popup-content-wrapper {
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 8px;
        }

        .map-stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 41, 59, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
        }

        /* Loading */
        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state-icon {
            width: 120px;
            height: 120px;
            margin-bottom: 24px;
            opacity: 0.6;
        }

        .empty-state-icon svg {
            width: 100%;
            height: 100%;
        }

        .empty-state h2 {
            font-size: 28px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .empty-state p {
            color: var(--text-muted);
            font-size: 16px;
            max-width: 400px;
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lightbox-delete {
            position: absolute;
            top: 20px;
            right: 80px;
            background: rgba(239, 68, 68, 0.8);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .lightbox-delete:hover {
            background: rgba(239, 68, 68, 1);
        }

        .lightbox-add-collection {
            position: absolute;
            top: 20px;
            right: 140px;
            background: rgba(102, 126, 234, 0.8);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .lightbox-add-collection:hover {
            background: rgba(102, 126, 234, 1);
        }

        /* Collection Modal */
        .collection-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-black, rgba(0, 0, 0, 0.8));
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .collection-modal.active {
            display: flex;
        }

        .collection-modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
        }

        .collection-modal h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .collection-list {
            margin-bottom: 16px;
        }

        .collection-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .collection-option:hover {
            background: var(--bg-tertiary);
        }

        .collection-option.selected {
            background: var(--accent-primary);
        }

        .collection-option-name {
            flex: 1;
            font-weight: 500;
        }

        .collection-option-count {
            color: var(--text-muted);
            font-size: 13px;
        }

        .collection-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .collection-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .collection-modal-btn.cancel {
            background: var(--bg-tertiary);
            color: white;
        }

        .collection-modal-btn.confirm {
            background: var(--accent-primary);
            color: white;
        }

        .collection-modal-btn.confirm:hover {
            background: var(--accent-hover, #5a67d8);
        }

        .no-collections {
            color: var(--text-muted);
            text-align: center;
            padding: 20px;
        }

        .create-collection-link {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .create-collection-link:hover {
            text-decoration: underline;
        }

        /* Delete Modal */
        .delete-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-black, rgba(0, 0, 0, 0.8));
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .delete-modal.active {
            display: flex;
        }

        .delete-modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
        }

        .delete-modal-content h3 {
            margin-bottom: 12px;
            font-size: 20px;
        }

        .delete-modal-content p {
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .delete-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .delete-modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .delete-modal-btn.cancel {
            background: var(--bg-tertiary);
            color: white;
        }

        .delete-modal-btn.cancel:hover {
            background: var(--bg-tertiary-hover, #475569);
        }

        .delete-modal-btn.confirm {
            background: var(--semantic-error, #ef4444);
            color: white;
        }

        .delete-modal-btn.confirm:hover {
            background: var(--semantic-error-dark, #dc2626);
        }

        .delete-api-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #475569;
            border-radius: 6px;
            background: var(--bg-primary);
            color: white;
            font-size: 14px;
        }

        .delete-api-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .delete-auth-error {
            color: var(--semantic-error);
            font-size: 13px;
            margin-bottom: 16px;
            min-height: 20px;
        }

        .lightbox-content {
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
        }

        .lightbox-loading {
            color: white;
            font-size: 18px;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 36px;
            cursor: pointer;
            padding: 16px;
            border-radius: 50%;
        }

        .lightbox-nav:hover {
            background: rgba(255,255,255,0.2);
        }

        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }

        .lightbox-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 12px 24px;
            border-radius: 8px;
            max-width: 90%;
        }

        .lightbox-info .filename {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .lightbox-info .date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .lightbox-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Infinite scroll sentinel */
        .scroll-sentinel {
            height: 1px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .photo-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 2px;
                padding: 2px;
            }

            .skeleton-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 2px;
                padding: 2px;
            }

            .navbar {
                padding: 12px 16px;
            }

            .navbar-brand {
                font-size: 20px;
            }

            .navbar-controls {
                gap: 12px;
            }

            .view-toggle {
                padding: 2px;
                gap: 2px;
            }

            .view-btn {
                padding: 8px 10px;
                font-size: 14px;
            }

            .select-mode-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .user-menu-btn {
                padding: 8px 12px;
                gap: 8px;
            }

            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .user-name {
                display: none;
            }

            .lightbox-nav {
                padding: 12px;
                font-size: 24px;
            }

            .carousel-nav {
                padding: 12px;
                font-size: 32px;
            }

            .carousel-meta {
                flex-wrap: wrap;
                gap: 8px;
            }

            .photo-list .photo-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">PhotoSync</div>
        <div class="navbar-controls">
            <button class="select-mode-btn" id="select-mode-btn" onclick="toggleSelectMode()" title="Select photos">Select</button>
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" title="Grid View">&#9638;</button>
                <button class="view-btn" data-view="large" title="Large Grid">&#9635;</button>
                <button class="view-btn" data-view="list" title="List View">&#9776;</button>
                <button class="view-btn" data-view="carousel" title="Carousel">&#9654;</button>
                <button class="view-btn" data-view="map" title="Map View">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                        <line x1="8" y1="2" x2="8" y2="18"></line>
                        <line x1="16" y1="6" x2="16" y2="22"></line>
                    </svg>
                </button>
            </div>
            <div class="navbar-user">
                <div class="user-menu-btn" id="user-menu-btn" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="user-avatar"></div>
                    <span class="user-name" id="user-name"></span>
                    <span class="user-menu-icon">▼</span>
                </div>
                <div class="user-dropdown" id="user-dropdown">
                    <a href="/collections" class="dropdown-item">
                        <span class="dropdown-item-icon">&#128194;</span>
                        <span>Collections</span>
                    </a>
                    <a href="/admin" class="dropdown-item" id="admin-menu-item" style="display: none;">
                        <span class="dropdown-item-icon">&#9881;</span>
                        <span>Admin Settings</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <div class="theme-selector">
                        <button class="theme-dropdown-btn" id="themeDropdownBtn" onclick="toggleThemeDropdown(event)">
                            <div class="theme-dropdown-current">
                                <div class="theme-preview-mini" id="currentThemePreview"></div>
                                <span id="currentThemeName">Dark</span>
                            </div>
                            <span class="theme-dropdown-arrow">&#9662;</span>
                        </button>
                        <div class="theme-dropdown-menu" id="themeDropdownMenu">
                            <!-- Themes loaded dynamically from API -->
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="logout()">
                        <span class="dropdown-item-icon">&#128682;</span>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="gallery-header" id="gallery-header">
        <div class="gallery-stats" id="gallery-stats">Loading photos...</div>
    </div>

    <!-- Skeleton Loader -->
    <div class="skeleton-grid" id="skeleton-loader">
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
        <div class="photo-skeleton"></div>
    </div>

    <div class="photo-grid" id="photo-container" style="display: none;"></div>

    <div class="loading-indicator" id="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <div>Loading more photos...</div>
    </div>

    <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-state-icon">
            <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="90" stroke="currentColor" stroke-width="2" opacity="0.2"/>
                <circle cx="100" cy="100" r="60" stroke="currentColor" stroke-width="3" opacity="0.3"/>
                <circle cx="100" cy="100" r="30" fill="currentColor" opacity="0.4"/>
                <path d="M60 80 L100 40 L140 80" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"/>
                <path d="M70 120 L100 90 L130 120" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"/>
                <rect x="40" y="60" width="120" height="90" rx="8" stroke="currentColor" stroke-width="3" fill="none" opacity="0.4"/>
                <circle cx="130" cy="80" r="8" fill="currentColor" opacity="0.5"/>
            </svg>
        </div>
        <h2>No Photos Yet</h2>
        <p>Photos you sync from the mobile app will appear here</p>
    </div>

    <div class="scroll-sentinel" id="scroll-sentinel"></div>

    <!-- Carousel View -->
    <div class="carousel-container" id="carousel-container">
        <div class="carousel-main">
            <button class="carousel-nav carousel-prev" onclick="carouselPrev()">&#8249;</button>
            <div class="carousel-image-wrapper">
                <img class="carousel-image" id="carousel-image" src="" alt="">
            </div>
            <button class="carousel-nav carousel-next" onclick="carouselNext()">&#8250;</button>
        </div>
        <div class="carousel-progress">
            <div class="carousel-progress-bar" id="carousel-progress"></div>
        </div>
        <div class="carousel-info">
            <div class="carousel-meta" id="carousel-meta"></div>
            <div class="carousel-controls">
                <button class="carousel-btn" id="autoplay-btn" onclick="toggleAutoplay()">&#9654; Auto</button>
                <span id="carousel-counter">1 / 100</span>
            </div>
        </div>
        <div class="carousel-strip" id="carousel-strip"></div>
    </div>

    <!-- Map View -->
    <div class="map-container" id="map-container">
        <div id="photo-map"></div>
        <div class="map-stats" id="map-stats">Loading photos with locations...</div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-counter" id="lightbox-counter">1 / 100</div>
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <button class="lightbox-delete" onclick="deleteCurrentPhoto()" title="Delete photo">&#128465;</button>
        <button class="lightbox-add-collection" onclick="showAddToCollectionModal()" title="Add to Collection">&#128194;</button>
        <button class="lightbox-nav lightbox-prev" onclick="prevPhoto()">&#8249;</button>
        <div class="lightbox-content">
            <div class="lightbox-loading" id="lightbox-loading">Loading...</div>
            <img class="lightbox-image" id="lightbox-image" src="" alt="" style="display: none;">
        </div>
        <button class="lightbox-nav lightbox-next" onclick="nextPhoto()">&#8250;</button>
        <div class="lightbox-info">
            <div class="filename" id="lightbox-filename"></div>
            <div class="date" id="lightbox-date"></div>
        </div>
    </div>

    <!-- Delete Authorization Modal -->
    <div class="delete-modal" id="delete-auth-modal">
        <div class="delete-modal-content">
            <h3>Authorize Deletion</h3>
            <p>Enter your API key to enable photo deletion for this session.</p>
            <input type="password" id="delete-api-key" class="delete-api-input" placeholder="API Key">
            <div id="delete-auth-error" class="delete-auth-error"></div>
            <div class="delete-modal-actions">
                <button class="delete-modal-btn cancel" onclick="cancelDeleteAuth()">Cancel</button>
                <button class="delete-modal-btn confirm" onclick="verifyDeleteAuth()">Authorize</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-modal" id="delete-modal">
        <div class="delete-modal-content">
            <h3>Delete Photo?</h3>
            <p>Are you sure you want to delete this photo? This action cannot be undone.</p>
            <div class="delete-modal-actions">
                <button class="delete-modal-btn cancel" onclick="cancelDelete()">Cancel</button>
                <button class="delete-modal-btn confirm" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add to Collection Modal -->
    <div class="collection-modal" id="collection-modal">
        <div class="collection-modal-content">
            <h3>Add to Collection</h3>
            <div class="collection-list" id="collection-list">
                <div class="no-collections">Loading collections...</div>
            </div>
            <div class="collection-modal-actions">
                <button class="collection-modal-btn cancel" onclick="closeCollectionModal()">Cancel</button>
                <button class="collection-modal-btn confirm" id="add-to-collection-btn" onclick="addPhotosToSelectedCollection()" disabled>Add</button>
            </div>
        </div>
    </div>

    <!-- Selection Action Bar -->
    <div class="selection-bar" id="selection-bar">
        <div class="selection-info">
            <span id="selection-count">0</span> of <span id="selection-total">0</span> photos selected
        </div>
        <div class="selection-actions">
            <button class="selection-btn secondary" onclick="clearSelection()">Clear</button>
            <button class="selection-btn secondary" id="select-all-btn" onclick="selectAllPhotos()">Select All (<span id="select-all-count">0</span>)</button>
            <button class="selection-btn primary" onclick="showBulkAddToCollection()">Add to Collection</button>
            <button class="selection-btn danger" id="bulk-delete-btn" onclick="showBulkDelete()">Delete</button>
        </div>
    </div>

    <!-- Bulk Delete Modal -->
    <div class="bulk-delete-modal" id="bulk-delete-modal">
        <div class="bulk-delete-modal-content">
            <div id="bulk-delete-confirm" class="bulk-delete-stage">
                <h3>Delete <span id="bulk-delete-count">0</span> Photos?</h3>
                <p class="bulk-delete-warning">This action cannot be undone. A notification will be sent to your phone for approval.</p>
                <div class="bulk-delete-actions">
                    <button class="bulk-delete-btn cancel" onclick="closeBulkDeleteModal()">Cancel</button>
                    <button class="bulk-delete-btn confirm" onclick="initiateBulkDelete()">Request Deletion</button>
                </div>
            </div>
            <div id="bulk-delete-pending" class="bulk-delete-stage" style="display: none;">
                <div class="bulk-delete-pending-icon">&#128241;</div>
                <h3>Waiting for Phone Approval</h3>
                <p>Please approve or deny this request on your phone.</p>
                <div class="bulk-delete-timer">
                    Expires in <span id="bulk-delete-timer">60</span>s
                </div>
                <div class="bulk-delete-spinner"></div>
                <button class="bulk-delete-btn cancel" onclick="cancelBulkDelete()">Cancel</button>
            </div>
            <div id="bulk-delete-success" class="bulk-delete-stage" style="display: none;">
                <div class="bulk-delete-success-icon">&#10003;</div>
                <h3>Photos Deleted</h3>
                <p><span id="bulk-delete-deleted-count">0</span> photos have been deleted.</p>
                <button class="bulk-delete-btn confirm" onclick="closeBulkDeleteModal()">Done</button>
            </div>
            <div id="bulk-delete-denied" class="bulk-delete-stage" style="display: none;">
                <div class="bulk-delete-denied-icon">&#10007;</div>
                <h3>Deletion Denied</h3>
                <p>The delete request was denied from your phone.</p>
                <button class="bulk-delete-btn cancel" onclick="closeBulkDeleteModal()">Close</button>
            </div>
            <div id="bulk-delete-error" class="bulk-delete-stage" style="display: none;">
                <div class="bulk-delete-error-icon">&#9888;</div>
                <h3>Error</h3>
                <p id="bulk-delete-error-msg">Something went wrong.</p>
                <button class="bulk-delete-btn cancel" onclick="closeBulkDeleteModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS for map view -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        let photos = [];
        let locationPhotos = [];
        let currentPhotoIndex = 0;
        let skip = 0;
        const take = 50;
        let totalCount = 0;
        let loading = false;
        let hasMore = true;
        let lastMonthHeader = null;
        let currentView = 'grid';
        let map = null;
        let markerCluster = null;
        let autoplayInterval = null;
        let autoplayActive = false;

        // Check session and load user info
        fetch('/api/web/session')
            .then(r => {
                if (!r.ok) {
                    window.location.href = '/login.html';
                    throw new Error('Not authenticated');
                }
                return r.json();
            })
            .then(session => {
                const displayName = session.user.displayName;
                document.getElementById('user-name').textContent = displayName;

                // Set user avatar initials
                const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                document.getElementById('user-avatar').textContent = initials;

                // Show admin menu item if admin
                if (session.user.isAdmin) {
                    document.getElementById('admin-menu-item').style.display = 'flex';
                }

                loadPhotos();
                setupInfiniteScroll();
            })
            .catch(() => {});

        function loadPhotos() {
            if (loading || !hasMore) return;
            loading = true;

            // Reset month header tracking when starting fresh
            if (photos.length === 0) {
                lastMonthHeader = null;
            }

            if (photos.length > 0) {
                document.getElementById('loading').style.display = 'block';
            }

            fetch(`/api/web/photos?skip=${skip}&take=${take}`)
                .then(r => r.json())
                .then(data => {
                    loading = false;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('skeleton-loader').style.display = 'none';

                    totalCount = data.totalCount;
                    document.getElementById('gallery-stats').textContent =
                        `${totalCount.toLocaleString()} photos`;

                    if (data.photos && data.photos.length > 0) {
                        document.getElementById('photo-container').style.display = '';
                        const startIndex = photos.length;
                        photos = photos.concat(data.photos);
                        renderPhotos(data.photos, startIndex);
                        skip += data.photos.length;
                        hasMore = skip < totalCount;

                        // Update carousel strip if in carousel view
                        if (currentView === 'carousel') {
                            updateCarouselStrip();
                        }
                    } else if (photos.length === 0) {
                        document.getElementById('empty-state').style.display = 'block';
                        hasMore = false;
                    }
                })
                .catch(err => {
                    loading = false;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('skeleton-loader').style.display = 'none';
                    console.error('Failed to load photos:', err);
                });
        }

        function renderPhotos(newPhotos, startIndex) {
            const container = document.getElementById('photo-container');
            const fragment = document.createDocumentFragment();

            newPhotos.forEach((photo, i) => {
                const index = startIndex + i;

                // Add year/month header if changed
                try {
                    const photoDate = new Date(photo.dateTaken);
                    if (!isNaN(photoDate.getTime())) {
                        const yearMonth = photoDate.getFullYear() + '-' + String(photoDate.getMonth() + 1).padStart(2, '0');
                        if (yearMonth !== lastMonthHeader) {
                            const header = document.createElement('div');
                            header.className = 'month-header';
                            const monthName = photoDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });
                            header.textContent = monthName;
                            fragment.appendChild(header);
                            lastMonthHeader = yearMonth;
                        }
                    }
                } catch (e) {
                    console.error('Error creating month header:', e);
                }
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.dataset.photoId = photo.id;
                div.dataset.index = index;
                div.onclick = (e) => handlePhotoClick(e, index, photo.id);

                // Selection checkbox
                const checkbox = document.createElement('div');
                checkbox.className = 'select-checkbox';
                div.appendChild(checkbox);

                // Selection overlay (for selected state)
                const selectionOverlay = document.createElement('div');
                selectionOverlay.className = 'selection-overlay';
                div.appendChild(selectionOverlay);

                // Skeleton placeholder - starts with loading animation
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-placeholder loading';
                div.appendChild(skeleton);

                // Lazy loaded image with appropriate size
                const img = document.createElement('img');
                const thumbSize = currentView === 'list' ? 'small' : (currentView === 'large' ? 'medium' : 'small');
                img.dataset.src = `/api/web/photos/${photo.id}/thumbnail?size=${thumbSize}`;
                img.alt = photo.originalFilename;
                img.onload = function() {
                    this.classList.add('loaded');
                    skeleton.remove(); // Remove skeleton entirely once loaded
                };
                div.appendChild(img);

                // Overlay info (for grid view)
                const overlay = document.createElement('div');
                overlay.className = 'photo-overlay';
                overlay.textContent = formatDate(photo.dateTaken);
                div.appendChild(overlay);

                // Date/time label below photo (always visible in grid view)
                const dateLabel = document.createElement('div');
                dateLabel.className = 'photo-date-label';
                dateLabel.textContent = formatDateTime(photo.dateTaken);
                div.appendChild(dateLabel);

                // For list view - detailed info
                const info = document.createElement('div');
                info.className = 'photo-info';
                info.innerHTML = buildPhotoInfoHTML(photo);
                div.appendChild(info);

                fragment.appendChild(div);

                // Observe for lazy loading
                lazyLoadObserver.observe(img);
            });

            container.appendChild(fragment);
        }

        function buildPhotoInfoHTML(photo) {
            let html = `<div class="photo-filename">${escapeHtml(photo.originalFilename)}</div>`;
            html += '<div class="photo-meta">';

            // Date
            html += `<div class="meta-item"><span class="meta-label">Date:</span><span class="meta-value">${formatDateTime(photo.dateTaken)}</span></div>`;

            // Dimensions
            if (photo.width && photo.height) {
                html += `<div class="meta-item"><span class="meta-label">Size:</span><span class="meta-value">${photo.width} x ${photo.height}</span></div>`;
            }

            // File size
            if (photo.fileSize) {
                html += `<div class="meta-item"><span class="meta-label">File:</span><span class="meta-value">${formatFileSize(photo.fileSize)}</span></div>`;
            }

            // Camera
            if (photo.cameraMake || photo.cameraModel) {
                const camera = [photo.cameraMake, photo.cameraModel].filter(Boolean).join(' ');
                html += `<div class="meta-item"><span class="meta-label">Camera:</span><span class="meta-value">${escapeHtml(camera)}</span></div>`;
            }

            // Lens
            if (photo.lensModel) {
                html += `<div class="meta-item"><span class="meta-label">Lens:</span><span class="meta-value">${escapeHtml(photo.lensModel)}</span></div>`;
            }

            // Settings
            const settings = [];
            if (photo.focalLength) settings.push(photo.focalLength);
            if (photo.aperture) settings.push(photo.aperture);
            if (photo.shutterSpeed) settings.push(photo.shutterSpeed);
            if (photo.iso) settings.push(`ISO ${photo.iso}`);
            if (settings.length > 0) {
                html += `<div class="meta-item"><span class="meta-label">Settings:</span><span class="meta-value">${escapeHtml(settings.join(' | '))}</span></div>`;
            }

            // Location
            if (photo.latitude && photo.longitude) {
                const mapsUrl = `https://www.google.com/maps?q=${photo.latitude},${photo.longitude}`;
                html += `<div class="meta-item"><span class="meta-label">Location:</span><a class="meta-link" href="${mapsUrl}" target="_blank" onclick="event.stopPropagation()">View on Google Maps</a></div>`;
            }

            html += '</div>';
            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Lazy loading with Intersection Observer
        const lazyLoadObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        delete img.dataset.src;
                        lazyLoadObserver.unobserve(img);
                    }
                }
            });
        }, {
            rootMargin: '200px'
        });

        // Infinite scroll
        function setupInfiniteScroll() {
            const sentinel = document.getElementById('scroll-sentinel');
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !loading && hasMore) {
                    loadPhotos();
                }
            }, {
                rootMargin: '500px'
            });
            observer.observe(sentinel);
        }

        // View switching
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const view = btn.dataset.view;
                switchView(view);
            });
        });

        function switchView(view) {
            currentView = view;
            const container = document.getElementById('photo-container');
            const carousel = document.getElementById('carousel-container');
            const mapContainer = document.getElementById('map-container');
            const header = document.getElementById('gallery-header');
            const scrollSentinel = document.getElementById('scroll-sentinel');

            // Hide all views first
            carousel.classList.remove('active');
            mapContainer.classList.remove('active');
            container.style.display = '';
            header.style.display = '';
            scrollSentinel.style.display = '';
            stopAutoplay();

            if (view === 'carousel') {
                container.style.display = 'none';
                header.style.display = 'none';
                scrollSentinel.style.display = 'none';
                carousel.classList.add('active');
                initCarousel();
            } else if (view === 'map') {
                container.style.display = 'none';
                header.style.display = 'none';
                scrollSentinel.style.display = 'none';
                mapContainer.classList.add('active');
                initMap();
            } else {
                container.className = view === 'list' ? 'photo-list' :
                                     view === 'large' ? 'photo-grid large' : 'photo-grid';
            }
        }

        // Carousel
        function initCarousel() {
            if (photos.length === 0) return;
            currentPhotoIndex = 0;
            updateCarousel();
            updateCarouselStrip();
        }

        function updateCarouselStrip() {
            const strip = document.getElementById('carousel-strip');
            strip.innerHTML = '';

            photos.forEach((photo, i) => {
                const thumb = document.createElement('img');
                thumb.className = 'carousel-thumb' + (i === currentPhotoIndex ? ' active' : '');
                thumb.src = `/api/web/photos/${photo.id}/thumbnail?size=small`;
                thumb.alt = photo.originalFilename;
                thumb.onclick = () => {
                    currentPhotoIndex = i;
                    updateCarousel();
                };
                strip.appendChild(thumb);
            });
        }

        function updateCarousel() {
            const photo = photos[currentPhotoIndex];
            if (!photo) return;

            const img = document.getElementById('carousel-image');
            img.src = `/api/web/photos/${photo.id}/thumbnail?size=large`;

            // Update counter
            document.getElementById('carousel-counter').textContent =
                `${currentPhotoIndex + 1} / ${totalCount}`;

            // Update progress bar
            document.getElementById('carousel-progress').style.width =
                `${((currentPhotoIndex + 1) / totalCount) * 100}%`;

            // Update meta info
            const meta = document.getElementById('carousel-meta');
            let metaHtml = `<span>${escapeHtml(photo.originalFilename)}</span>`;
            metaHtml += `<span>${formatDateTime(photo.dateTaken)}</span>`;
            if (photo.cameraMake || photo.cameraModel) {
                metaHtml += `<span>${escapeHtml([photo.cameraMake, photo.cameraModel].filter(Boolean).join(' '))}</span>`;
            }
            if (photo.latitude && photo.longitude) {
                metaHtml += `<a href="https://www.google.com/maps?q=${photo.latitude},${photo.longitude}" target="_blank" style="color: var(--accent-primary);">View Location</a>`;
            }
            meta.innerHTML = metaHtml;

            // Update active thumb
            document.querySelectorAll('.carousel-thumb').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === currentPhotoIndex);
            });

            // Scroll thumb into view
            const activeThumb = document.querySelector('.carousel-thumb.active');
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }

            // Load more if near the end
            if (currentPhotoIndex >= photos.length - 5 && hasMore) {
                loadPhotos();
            }
        }

        function carouselPrev() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updateCarousel();
            }
        }

        function carouselNext() {
            if (currentPhotoIndex < photos.length - 1) {
                currentPhotoIndex++;
                updateCarousel();
            } else if (hasMore) {
                loadPhotos();
            }
        }

        function toggleAutoplay() {
            if (autoplayActive) {
                stopAutoplay();
            } else {
                startAutoplay();
            }
        }

        function startAutoplay() {
            autoplayActive = true;
            document.getElementById('autoplay-btn').classList.add('active');
            document.getElementById('autoplay-btn').innerHTML = '&#10074;&#10074; Auto';
            autoplayInterval = setInterval(() => {
                if (currentPhotoIndex < photos.length - 1) {
                    currentPhotoIndex++;
                    updateCarousel();
                } else if (hasMore) {
                    loadPhotos();
                } else {
                    currentPhotoIndex = 0;
                    updateCarousel();
                }
            }, 5000);
        }

        function stopAutoplay() {
            autoplayActive = false;
            if (autoplayInterval) {
                clearInterval(autoplayInterval);
                autoplayInterval = null;
            }
            const btn = document.getElementById('autoplay-btn');
            if (btn) {
                btn.classList.remove('active');
                btn.innerHTML = '&#9654; Auto';
            }
        }

        // Map View
        function initMap() {
            if (map) {
                map.invalidateSize();
                return;
            }

            // Initialize map
            map = L.map('photo-map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            markerCluster = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50
            });
            map.addLayer(markerCluster);

            // Load photos with locations
            loadLocationPhotos();
        }

        function loadLocationPhotos() {
            document.getElementById('map-stats').textContent = 'Loading photos with locations...';

            fetch('/api/web/photos/locations?take=1000')
                .then(r => r.json())
                .then(data => {
                    locationPhotos = data.photos || [];
                    document.getElementById('map-stats').textContent =
                        `${locationPhotos.length} photos with location data`;

                    if (locationPhotos.length === 0) {
                        document.getElementById('map-stats').textContent =
                            'No photos with location data found';
                        return;
                    }

                    // Add markers
                    const bounds = [];
                    locationPhotos.forEach(photo => {
                        if (photo.latitude && photo.longitude) {
                            const marker = L.marker([photo.latitude, photo.longitude]);

                            const popupContent = `
                                <img class="map-popup-thumb"
                                     src="/api/web/photos/${photo.id}/thumbnail?size=small"
                                     alt="${escapeHtml(photo.originalFilename)}"
                                     onclick="openLightboxForPhoto('${photo.id}')">
                                <div class="map-popup-info">
                                    <strong>${escapeHtml(photo.originalFilename)}</strong><br>
                                    ${formatDate(photo.dateTaken)}
                                </div>
                            `;
                            marker.bindPopup(popupContent);
                            markerCluster.addLayer(marker);
                            bounds.push([photo.latitude, photo.longitude]);
                        }
                    });

                    if (bounds.length > 0) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                })
                .catch(err => {
                    console.error('Failed to load location photos:', err);
                    document.getElementById('map-stats').textContent =
                        'Failed to load location data';
                });
        }

        function openLightboxForPhoto(photoId) {
            const index = photos.findIndex(p => p.id === photoId);
            if (index >= 0) {
                openLightbox(index);
            } else {
                // Photo might be in locationPhotos but not in main photos array
                const locPhoto = locationPhotos.find(p => p.id === photoId);
                if (locPhoto) {
                    // Add to photos temporarily and open
                    const tempIndex = photos.length;
                    photos.push(locPhoto);
                    openLightbox(tempIndex);
                }
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Lightbox
        function openLightbox(index) {
            currentPhotoIndex = index;
            updateLightbox();
            document.getElementById('lightbox').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = '';
            document.getElementById('lightbox-image').src = '';
        }

        function updateLightbox() {
            const photo = photos[currentPhotoIndex];
            const img = document.getElementById('lightbox-image');
            const loadingEl = document.getElementById('lightbox-loading');

            loadingEl.style.display = 'block';
            img.style.display = 'none';

            document.getElementById('lightbox-counter').textContent =
                `${currentPhotoIndex + 1} / ${totalCount}`;

            document.getElementById('lightbox-filename').textContent = photo.originalFilename;
            document.getElementById('lightbox-date').textContent = formatDateTime(photo.dateTaken);

            img.onload = function() {
                loadingEl.style.display = 'none';
                img.style.display = 'block';
            };
            img.src = `/api/web/photos/${photo.id}/image`;
        }

        function prevPhoto() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updateLightbox();
            }
        }

        function nextPhoto() {
            if (currentPhotoIndex < photos.length - 1) {
                currentPhotoIndex++;
                updateLightbox();

                if (currentPhotoIndex >= photos.length - 5 && hasMore) {
                    loadPhotos();
                }
            }
        }

        function logout() {
            fetch('/api/web/auth/logout', { method: 'POST' })
                .then(() => {
                    window.location.href = '/login.html';
                });
        }

        // Delete functionality
        let deleteApiKey = null;  // Stored in memory only for this session
        let pendingDeleteIndex = null;

        function deleteCurrentPhoto() {
            if (!deleteApiKey) {
                // Need to authorize first
                document.getElementById('delete-auth-modal').classList.add('active');
                document.getElementById('delete-api-key').focus();
            } else {
                // Already authorized, show confirmation
                pendingDeleteIndex = currentPhotoIndex;
                document.getElementById('delete-modal').classList.add('active');
            }
        }

        function cancelDeleteAuth() {
            document.getElementById('delete-auth-modal').classList.remove('active');
            document.getElementById('delete-api-key').value = '';
            document.getElementById('delete-auth-error').textContent = '';
        }

        function verifyDeleteAuth() {
            const apiKey = document.getElementById('delete-api-key').value.trim();
            if (!apiKey) {
                document.getElementById('delete-auth-error').textContent = 'Please enter your API key';
                return;
            }

            // Verify API key by trying to access the API
            fetch('/api/photos?take=1', {
                headers: { 'X-API-Key': apiKey }
            })
            .then(r => {
                if (r.ok) {
                    deleteApiKey = apiKey;
                    cancelDeleteAuth();
                    // Now show the delete confirmation
                    pendingDeleteIndex = currentPhotoIndex;
                    document.getElementById('delete-modal').classList.add('active');
                } else {
                    document.getElementById('delete-auth-error').textContent = 'Invalid API key';
                }
            })
            .catch(() => {
                document.getElementById('delete-auth-error').textContent = 'Failed to verify API key';
            });
        }

        function cancelDelete() {
            document.getElementById('delete-modal').classList.remove('active');
            pendingDeleteIndex = null;
        }

        function confirmDelete() {
            if (pendingDeleteIndex === null) return;

            const photo = photos[pendingDeleteIndex];

            // Use the API key to delete
            fetch(`/api/photos/${photo.id}`, {
                method: 'DELETE',
                headers: { 'X-API-Key': deleteApiKey }
            })
            .then(r => {
                if (r.ok || r.status === 204) {
                    // Remove from photos array
                    photos.splice(pendingDeleteIndex, 1);
                    totalCount--;

                    // Update gallery stats
                    document.getElementById('gallery-stats').textContent =
                        `${totalCount.toLocaleString()} photos`;

                    // Remove from DOM
                    const container = document.getElementById('photo-container');
                    if (container.children[pendingDeleteIndex]) {
                        container.children[pendingDeleteIndex].remove();
                    }

                    // Close modal
                    cancelDelete();

                    // Navigate to next photo or close lightbox
                    if (photos.length === 0) {
                        closeLightbox();
                        document.getElementById('empty-state').style.display = 'block';
                    } else if (currentPhotoIndex >= photos.length) {
                        currentPhotoIndex = photos.length - 1;
                        updateLightbox();
                    } else {
                        updateLightbox();
                    }
                } else {
                    alert('Failed to delete photo');
                    cancelDelete();
                }
            })
            .catch(err => {
                console.error('Delete failed:', err);
                alert('Failed to delete photo');
                cancelDelete();
            });
        }

        // Handle Enter key in API key input
        document.getElementById('delete-api-key').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                verifyDeleteAuth();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const lightbox = document.getElementById('lightbox');
            const carousel = document.getElementById('carousel-container');

            if (lightbox.classList.contains('active')) {
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft') prevPhoto();
                if (e.key === 'ArrowRight') nextPhoto();
            } else if (carousel.classList.contains('active')) {
                if (e.key === 'ArrowLeft') carouselPrev();
                if (e.key === 'ArrowRight') carouselNext();
                if (e.key === ' ') {
                    e.preventDefault();
                    toggleAutoplay();
                }
            }
        });

        // Touch swipe for lightbox
        let touchStartX = 0;
        document.getElementById('lightbox').addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });
        document.getElementById('lightbox').addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) nextPhoto();
                else prevPhoto();
            }
        });

        // Touch swipe for carousel
        document.getElementById('carousel-container').addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });
        document.getElementById('carousel-container').addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                if (diff > 0) carouselNext();
                else carouselPrev();
            }
        });

        // Selection Mode
        let selectMode = false;
        let selectedPhotoIds = new Set();

        // User menu dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            const button = document.getElementById('user-menu-btn');
            dropdown.classList.toggle('active');
            button.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('user-dropdown');
            const button = document.getElementById('user-menu-btn');
            if (dropdown && button && !button.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
                button.classList.remove('active');
            }
        });

        // Theme state
        let currentThemeId = null;
        let availableThemes = [];

        // Load and apply theme CSS from API
        async function loadThemeCSS(themeId) {
            try {
                const response = await fetch(`/api/themes/${themeId}/css`);
                if (!response.ok) {
                    console.error('Failed to load theme CSS');
                    return;
                }

                const css = await response.text();

                // Remove old theme style if exists
                const oldStyle = document.getElementById('dynamic-theme');
                if (oldStyle) {
                    oldStyle.remove();
                }

                // Inject new theme CSS
                const style = document.createElement('style');
                style.id = 'dynamic-theme';
                style.textContent = css;
                document.head.appendChild(style);

                currentThemeId = themeId;
            } catch (error) {
                console.error('Error loading theme:', error);
            }
        }

        // Load available themes from API
        async function loadAvailableThemes() {
            try {
                const response = await fetch('/api/themes');
                if (!response.ok) return;

                availableThemes = await response.json();

                // Populate theme dropdown menu
                const container = document.getElementById('themeDropdownMenu');
                if (!container) return;

                // Clear existing themes
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }

                // Add theme options
                availableThemes.forEach(theme => {
                    const option = document.createElement('button');
                    option.className = 'theme-option';
                    option.dataset.themeId = theme.id;
                    option.onclick = () => {
                        setTheme(theme.id);
                        closeThemeDropdown();
                    };

                    // Create preview graphic
                    const preview = document.createElement('div');
                    preview.className = 'theme-preview';
                    preview.style.background = getThemePreviewGradient(theme.id);

                    // Create info container
                    const info = document.createElement('div');
                    info.className = 'theme-option-info';

                    const name = document.createElement('div');
                    name.className = 'theme-option-name';
                    name.textContent = theme.name;

                    const description = document.createElement('div');
                    description.className = 'theme-option-description';
                    description.textContent = theme.description || getThemeDescription(theme.id);

                    info.appendChild(name);
                    info.appendChild(description);

                    option.appendChild(preview);
                    option.appendChild(info);
                    container.appendChild(option);
                });

                // Update active states
                updateThemeActiveStates();
            } catch (error) {
                console.error('Error loading themes:', error);
            }
        }

        // Get theme description
        function getThemeDescription(themeId) {
            const descriptions = {
                'dark': 'Classic dark theme with purple accents',
                'light': 'Clean light theme for bright environments',
                'minimal': 'Minimalist monochrome design',
                'gallery': 'Museum-inspired elegant theme',
                'magazine': 'Editorial magazine-style layout'
            };
            return descriptions[themeId] || 'Custom theme';
        }

        // Toggle theme dropdown
        function toggleThemeDropdown(event) {
            event.stopPropagation();
            const btn = document.getElementById('themeDropdownBtn');
            const menu = document.getElementById('themeDropdownMenu');

            const isOpen = menu.classList.contains('open');

            if (isOpen) {
                closeThemeDropdown();
            } else {
                btn.classList.add('open');
                menu.classList.add('open');
            }
        }

        // Close theme dropdown
        function closeThemeDropdown() {
            const btn = document.getElementById('themeDropdownBtn');
            const menu = document.getElementById('themeDropdownMenu');
            btn.classList.remove('open');
            menu.classList.remove('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const themeSelector = document.querySelector('.theme-selector');
            if (themeSelector && !themeSelector.contains(e.target)) {
                closeThemeDropdown();
            }
        });

        // Get preview gradient for theme
        function getThemePreviewGradient(themeId) {
            const gradients = {
                'dark': 'linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%)',
                'light': 'linear-gradient(135deg, var(--accent-primary) 0%, #4f46e5 100%)',
                'minimal': 'linear-gradient(135deg, #424242 0%, #616161 100%)',
                'gallery': 'linear-gradient(135deg, #d4af37 0%, #c9a227 100%)',
                'magazine': 'linear-gradient(135deg, #e63946 0%, #d62828 100%)'
            };
            return gradients[themeId] || 'linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%)';
        }

        // Set theme and save preference
        async function setTheme(themeId) {
            await loadThemeCSS(themeId);

            // Save to user preferences
            try {
                await fetch('/api/users/me/preferences', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ globalThemeId: themeId })
                });
            } catch (error) {
                console.error('Failed to save theme preference:', error);
            }

            // Update current theme display
            updateCurrentThemeDisplay(themeId);
            updateThemeActiveStates();
        }

        // Update the current theme display in dropdown button
        function updateCurrentThemeDisplay(themeId) {
            const preview = document.getElementById('currentThemePreview');
            const name = document.getElementById('currentThemeName');

            if (preview) {
                preview.style.background = getThemePreviewGradient(themeId);
            }

            if (name && availableThemes) {
                const theme = availableThemes.find(t => t.id === themeId);
                if (theme) {
                    name.textContent = theme.name;
                }
            }
        }

        // Update active states on theme options
        function updateThemeActiveStates() {
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.themeId === currentThemeId);
            });
        }

        // Initialize theme on page load
        async function initTheme() {
            try {
                // Load available themes first
                await loadAvailableThemes();

                // Try to load user's preference
                const response = await fetch('/api/users/me/preferences', {
                    credentials: 'include'
                });

                let themeId = 'dark'; // Default fallback

                if (response.ok) {
                    const prefs = await response.json();
                    if (prefs.globalThemeId) {
                        themeId = prefs.globalThemeId;
                    }
                }

                // Load and apply the theme
                await loadThemeCSS(themeId);
                updateCurrentThemeDisplay(themeId);
                updateThemeActiveStates();
            } catch (error) {
                console.error('Error initializing theme:', error);
                // Fallback to dark theme
                await loadThemeCSS('dark');
                updateCurrentThemeDisplay('dark');
            }
        }

        // Load app info (app name, etc.)
        async function loadAppInfo() {
            try {
                const res = await fetch('/api/info');
                if (res.ok) {
                    const data = await res.json();
                    if (data.appName) {
                        document.querySelectorAll('.navbar-brand').forEach(el => {
                            el.textContent = data.appName;
                        });
                        document.title = data.appName + ' Gallery';
                    }
                }
            } catch (error) {
                console.log('Could not load app info:', error);
            }
        }

        // Add click handlers to theme buttons
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            loadAppInfo();

            // Theme buttons are dynamically created with onclick handlers
            // No need to add event listeners here
        });

        function toggleSelectMode() {
            selectMode = !selectMode;
            const container = document.getElementById('photo-container');
            const btn = document.getElementById('select-mode-btn');
            const selectionBar = document.getElementById('selection-bar');

            if (selectMode) {
                container.classList.add('select-mode');
                btn.classList.add('active');
                btn.textContent = 'Done';
            } else {
                container.classList.remove('select-mode');
                btn.classList.remove('active');
                btn.textContent = 'Select';
                clearSelection();
            }

            updateSelectionBar();
        }

        function handlePhotoClick(e, index, photoId) {
            if (selectMode) {
                e.preventDefault();
                e.stopPropagation();
                togglePhotoSelection(photoId);
            } else {
                openLightbox(index);
            }
        }

        function togglePhotoSelection(photoId) {
            const photoEl = document.querySelector(`.photo-item[data-photo-id="${photoId}"]`);

            if (selectedPhotoIds.has(photoId)) {
                selectedPhotoIds.delete(photoId);
                if (photoEl) photoEl.classList.remove('selected');
            } else {
                selectedPhotoIds.add(photoId);
                if (photoEl) photoEl.classList.add('selected');
            }

            updateSelectionBar();
        }

        function clearSelection() {
            selectedPhotoIds.clear();
            document.querySelectorAll('.photo-item.selected').forEach(el => {
                el.classList.remove('selected');
            });
            updateSelectionBar();
        }

        function selectAllPhotos() {
            // Select all loaded photos (from the photos array, not just visible DOM elements)
            photos.forEach(photo => {
                selectedPhotoIds.add(photo.id);
            });
            // Update DOM for visible items
            document.querySelectorAll('.photo-item').forEach(el => {
                const photoId = el.dataset.photoId;
                if (photoId && selectedPhotoIds.has(photoId)) {
                    el.classList.add('selected');
                }
            });
            updateSelectionBar();
        }

        function updateSelectionBar() {
            const selectionBar = document.getElementById('selection-bar');
            const countEl = document.getElementById('selection-count');
            const totalEl = document.getElementById('selection-total');
            const selectAllCountEl = document.getElementById('select-all-count');
            const deleteBtn = document.getElementById('bulk-delete-btn');
            const count = selectedPhotoIds.size;

            countEl.textContent = count.toLocaleString();
            totalEl.textContent = totalCount.toLocaleString();
            selectAllCountEl.textContent = totalCount.toLocaleString();

            // Disable delete button if ALL photos are selected (safety measure)
            const allSelected = count > 0 && count >= totalCount;
            deleteBtn.disabled = allSelected;
            deleteBtn.title = allSelected ? 'Cannot delete all photos at once' : 'Delete selected photos';

            // Update select all button text based on loaded vs total
            const selectAllBtn = document.getElementById('select-all-btn');
            if (photos.length < totalCount) {
                selectAllBtn.innerHTML = `Select All Loaded (<span id="select-all-count">${photos.length.toLocaleString()}</span> of ${totalCount.toLocaleString()})`;
            } else {
                selectAllBtn.innerHTML = `Select All (<span id="select-all-count">${totalCount.toLocaleString()}</span>)`;
            }

            if (selectMode && count > 0) {
                selectionBar.classList.add('active');
            } else {
                selectionBar.classList.remove('active');
            }
        }

        function showBulkAddToCollection() {
            if (selectedPhotoIds.size === 0) return;
            document.getElementById('collection-modal').classList.add('active');
            selectedCollectionId = null;
            document.getElementById('add-to-collection-btn').disabled = true;
            loadUserCollections();
        }

        // Collection Modal Functions
        let userCollections = [];
        let selectedCollectionId = null;

        async function showAddToCollectionModal() {
            document.getElementById('collection-modal').classList.add('active');
            selectedCollectionId = null;
            document.getElementById('add-to-collection-btn').disabled = true;
            await loadUserCollections();
        }

        function closeCollectionModal() {
            document.getElementById('collection-modal').classList.remove('active');
            selectedCollectionId = null;
        }

        async function loadUserCollections() {
            const listEl = document.getElementById('collection-list');
            listEl.innerHTML = '<div class="no-collections">Loading collections...</div>';

            try {
                const response = await fetch('/api/web/collections');
                if (!response.ok) throw new Error('Failed to load collections');
                const data = await response.json();
                userCollections = data.owned || [];

                if (userCollections.length === 0) {
                    listEl.innerHTML = `
                        <div class="no-collections">
                            <p>No collections yet</p>
                            <a href="/collections" class="create-collection-link">Create one</a>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = userCollections.map(c => `
                    <div class="collection-option" data-id="${c.id}" onclick="selectCollection('${c.id}')">
                        <span class="collection-option-name">${escapeHtmlAttr(c.name)}</span>
                        <span class="collection-option-count">${c.photoCount} photos</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load collections:', error);
                listEl.innerHTML = '<div class="no-collections">Failed to load collections</div>';
            }
        }

        function selectCollection(id) {
            selectedCollectionId = id;
            document.querySelectorAll('.collection-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === id);
            });
            document.getElementById('add-to-collection-btn').disabled = false;
        }

        async function addPhotosToSelectedCollection() {
            if (!selectedCollectionId) return;

            // Determine which photos to add: bulk selection or current lightbox photo
            let photoIds = [];
            if (selectMode && selectedPhotoIds.size > 0) {
                photoIds = Array.from(selectedPhotoIds);
            } else if (currentPhotoIndex >= 0 && currentPhotoIndex < photos.length) {
                photoIds = [photos[currentPhotoIndex].id];
            }

            if (photoIds.length === 0) return;

            const btn = document.getElementById('add-to-collection-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Adding...';
            btn.disabled = true;

            try {
                const response = await fetch(`/api/web/collections/${selectedCollectionId}/photos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoIds: photoIds })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to add photos');
                }

                closeCollectionModal();
                const count = photoIds.length;
                showToast(`${count} photo${count > 1 ? 's' : ''} added to collection`);

                // If in select mode, clear selection and exit
                if (selectMode && selectedPhotoIds.size > 0) {
                    clearSelection();
                    toggleSelectMode();
                }
            } catch (error) {
                console.error('Failed to add photos:', error);
                showToast(error.message || 'Failed to add photos', true);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function escapeHtmlAttr(str) {
            return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Toast notification
        function showToast(message, isError = false) {
            // Create toast if it doesn't exist
            let toast = document.getElementById('gallery-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'gallery-toast';
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 12px 24px;
                    background: var(--semantic-success, #10b981);
                    color: white;
                    border-radius: 8px;
                    z-index: 3000;
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(toast);
            }

            toast.textContent = message;
            toast.style.background = isError ? '#ef4444' : '#10b981';
            toast.style.display = 'block';
            toast.style.opacity = '1';

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { toast.style.display = 'none'; }, 300);
            }, 3000);
        }

        // Bulk Delete Functions
        let bulkDeleteRequestId = null;
        let bulkDeletePollInterval = null;
        let bulkDeleteTimerInterval = null;
        let bulkDeletePhotoIds = [];

        function showBulkDelete() {
            if (selectedPhotoIds.size === 0) return;

            // Don't allow deleting all photos
            if (selectedPhotoIds.size >= photos.length) {
                showToast('Cannot delete all photos at once', true);
                return;
            }

            bulkDeletePhotoIds = Array.from(selectedPhotoIds);
            document.getElementById('bulk-delete-count').textContent = bulkDeletePhotoIds.length;

            // Reset modal state
            showBulkDeleteStage('confirm');
            document.getElementById('bulk-delete-modal').classList.add('active');
        }

        function closeBulkDeleteModal() {
            document.getElementById('bulk-delete-modal').classList.remove('active');
            cancelBulkDeletePolling();
            bulkDeleteRequestId = null;
            bulkDeletePhotoIds = [];
        }

        function showBulkDeleteStage(stage) {
            const stages = ['confirm', 'pending', 'success', 'denied', 'error'];
            stages.forEach(s => {
                document.getElementById(`bulk-delete-${s}`).style.display = s === stage ? 'block' : 'none';
            });
        }

        async function initiateBulkDelete() {
            if (bulkDeletePhotoIds.length === 0) return;

            try {
                const response = await fetch('/api/web/delete/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoIds: bulkDeletePhotoIds })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to initiate delete request');
                }

                const result = await response.json();
                bulkDeleteRequestId = result.requestId;

                // Show pending stage
                showBulkDeleteStage('pending');

                // Start countdown timer
                const expiresAt = new Date(result.expiresAt);
                startBulkDeleteTimer(expiresAt);

                // Start polling for status
                startBulkDeletePolling();
            } catch (error) {
                console.error('Failed to initiate delete:', error);
                document.getElementById('bulk-delete-error-msg').textContent = error.message;
                showBulkDeleteStage('error');
            }
        }

        function startBulkDeleteTimer(expiresAt) {
            const updateTimer = () => {
                const now = new Date();
                const remaining = Math.max(0, Math.floor((expiresAt - now) / 1000));
                document.getElementById('bulk-delete-timer').textContent = remaining;

                if (remaining <= 0) {
                    clearInterval(bulkDeleteTimerInterval);
                }
            };

            updateTimer();
            bulkDeleteTimerInterval = setInterval(updateTimer, 1000);
        }

        function startBulkDeletePolling() {
            bulkDeletePollInterval = setInterval(async () => {
                if (!bulkDeleteRequestId) {
                    cancelBulkDeletePolling();
                    return;
                }

                try {
                    const response = await fetch(`/api/web/delete/status/${bulkDeleteRequestId}`);
                    if (!response.ok) {
                        throw new Error('Failed to check status');
                    }

                    const status = await response.json();

                    if (status.status === 'approved') {
                        cancelBulkDeletePolling();
                        handleBulkDeleteApproved();
                    } else if (status.status === 'denied') {
                        cancelBulkDeletePolling();
                        showBulkDeleteStage('denied');
                    } else if (status.status === 'expired') {
                        cancelBulkDeletePolling();
                        document.getElementById('bulk-delete-error-msg').textContent = 'Request expired. Please try again.';
                        showBulkDeleteStage('error');
                    }
                    // If still pending, keep polling
                } catch (error) {
                    console.error('Failed to poll status:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        function cancelBulkDeletePolling() {
            if (bulkDeletePollInterval) {
                clearInterval(bulkDeletePollInterval);
                bulkDeletePollInterval = null;
            }
            if (bulkDeleteTimerInterval) {
                clearInterval(bulkDeleteTimerInterval);
                bulkDeleteTimerInterval = null;
            }
        }

        function cancelBulkDelete() {
            cancelBulkDeletePolling();
            closeBulkDeleteModal();
        }

        function handleBulkDeleteApproved() {
            // Update count
            document.getElementById('bulk-delete-deleted-count').textContent = bulkDeletePhotoIds.length;

            // Remove deleted photos from local arrays
            bulkDeletePhotoIds.forEach(photoId => {
                const index = photos.findIndex(p => p.id === photoId);
                if (index !== -1) {
                    photos.splice(index, 1);
                }

                // Remove from DOM
                const photoEl = document.querySelector(`.photo-item[data-photo-id="${photoId}"]`);
                if (photoEl) {
                    photoEl.remove();
                }

                // Remove from selection
                selectedPhotoIds.delete(photoId);
            });

            // Update counts
            totalCount -= bulkDeletePhotoIds.length;
            document.getElementById('gallery-stats').textContent = `${totalCount.toLocaleString()} photos`;

            // Show success
            showBulkDeleteStage('success');

            // Clear selection and exit select mode after closing
            clearSelection();
        }
    </script>
</body>
</html>
